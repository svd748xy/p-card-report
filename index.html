<!DOCTYPE html>
<html>

<head>
    <title>PEæƒ…ç»ªå¡ç‰Œç®€æ˜“ä½¿ç”¨æŠ¥å‘Š</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .data-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        canvas {
            max-width: 600px;
            margin: 10px auto;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .input-group {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-type {
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        #consultation-event {
            width: 50%;
            margin-top: 10px;
            padding: 8px;
        }
        
        .delete-btn {
            background: #ff4444;
            padding: 5px 10px;
            margin: 0;
            cursor: pointer;
        }

        /* è¯æ±‡å’Œåˆ†å€¼é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ç»Ÿä¸€ */
        .word-select, .score-select {
            padding: 5px;
            width: 200px;
        }
        
        .score-select {
            width: 80px;
        }
        
        .blank-card-btn {
            background: #2196F3;
        }
        
        .type-select {
            width: 120px;
            padding: 5px;
        }

        /* å¡ç‰Œç»Ÿè®¡è¡¨æ ¼æ ·å¼ */
        .stats-table-container {
            margin-top: 30px;
        }
        
        .stats-table th, .stats-table td {
            text-align: center;
        }
        
        .stats-table th:first-child {
            text-align: left;
        }
        
        .color-indicator {
            width: 15px;
            height: 15px;
            display: inline-block;
            border-radius: 3px;
            margin-right: 5px;
        }
        
        /* å†…å®¹æ¦‚è¿°ç›¸å…³æ ·å¼ */
        .overview-btn {
            background: #9C27B0;
            margin-left: 10px;
        }
        
        .overview-input-container {
            margin: 10px 0 20px 0;
            display: none;
        }
        
        .overview-input {
            width: 100%;
            padding: 8px;
            min-height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        
        /* åŸºæœ¬ä¿¡æ¯è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        #basic-info-table th {
            background-color: #f5f5f5;
        }
        
        .overview-row td:first-child {
            font-weight: bold;
            width: 120px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- æ•°æ®è¾“å…¥éƒ¨åˆ† -->
        <div class="data-section">
            <h2>åŸºæœ¬ä¿¡æ¯</h2>
            <div>
                <input type="text" id="name" placeholder="å§“å" oninput="updateCharts()">
                <select id="gender" onchange="updateCharts()">
                    <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
                <input type="number" id="age" placeholder="å¹´é¾„" oninput="updateCharts()">
                <input type="date" id="date" oninput="updateCharts()">
            </div>
            
            <div style="margin-top: 15px;">
                <h3>å’¨è¯¢äº‹ä»¶</h3>
                <input type="text" id="consultation-event" placeholder="è¯·è¾“å…¥å’¨è¯¢äº‹ä»¶å†…å®¹" oninput="updateCharts()">
            </div>

            <h3>é¦–é€‰æƒ…ç»ªå¡ç‰Œ
                <button type="button" class="overview-btn" onclick="toggleOverview('emotion1-overview')">å†…å®¹æ¦‚è¿°</button>
            </h3>
            <div id="emotion1-overview" class="overview-input-container">
                <textarea class="overview-input" placeholder="è¯·è¾“å…¥é¦–é€‰æƒ…ç»ªå¡ç‰Œçš„å†…å®¹æ¦‚è¿°..." oninput="updateCharts()"></textarea>
            </div>
            <div id="emotion1-inputs">
                <button type="button" onclick="addEmotionInput('emotion1', false)">+ æ·»åŠ æƒ…ç»ªå¡ç‰Œ</button>
                <button type="button" class="blank-card-btn" onclick="addEmotionInput('emotion1', true)">ç©ºç™½å¡è¡¥å……</button>
            </div>

            <h3>ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œ
                <button type="button" class="overview-btn" onclick="toggleOverview('action-overview')">å†…å®¹æ¦‚è¿°</button>
            </h3>
            <div id="action-overview" class="overview-input-container">
                <textarea class="overview-input" placeholder="è¯·è¾“å…¥ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œçš„å†…å®¹æ¦‚è¿°..." oninput="updateCharts()"></textarea>
            </div>
            <div id="action-inputs">
                <button type="button" onclick="addActionInput(false)">+ æ·»åŠ è¡ŒåŠ¨å¡ç‰Œ</button>
                <button type="button" class="blank-card-btn" onclick="addActionInput(true)">ç©ºç™½å¡è¡¥å……</button>
            </div>

            <h3>å†é€‰æƒ…ç»ªå¡ç‰Œ
                <button type="button" class="overview-btn" onclick="toggleOverview('emotion2-overview')">å†…å®¹æ¦‚è¿°</button>
            </h3>
            <div id="emotion2-overview" class="overview-input-container">
                <textarea class="overview-input" placeholder="è¯·è¾“å…¥å†é€‰æƒ…ç»ªå¡ç‰Œçš„å†…å®¹æ¦‚è¿°..." oninput="updateCharts()"></textarea>
            </div>
            <div id="emotion2-inputs">
                <button type="button" onclick="addEmotionInput('emotion2', false)">+ æ·»åŠ æƒ…ç»ªå¡ç‰Œ</button>
                <button type="button" class="blank-card-btn" onclick="addEmotionInput('emotion2', true)">ç©ºç™½å¡è¡¥å……</button>
            </div>

            <button onclick="saveAsImage()">ğŸ’¾ ä¿å­˜ä¸ºå›¾ç‰‡</button>
        </div>

        <!-- å›¾è¡¨å±•ç¤ºéƒ¨åˆ† -->
        <div class="charts">
            <div><canvas id="emotion1Chart"></canvas></div>
            <div><canvas id="emotion2Chart"></canvas></div>
            <div><canvas id="actionTypeChart"></canvas></div>
            <div><canvas id="comparisonChart"></canvas></div>
            <div><canvas id="actionScoreChart"></canvas></div>
        </div>

        <!-- å¡ç‰Œç»Ÿè®¡è¡¨æ ¼ -->
        <div class="stats-table-container">
            <h2>å¡ç‰Œç±»å‹æ•°é‡ç»Ÿè®¡</h2>
            <table class="stats-table" id="card-stats-table">
                <thead>
                    <tr>
                        <th>å¡ç‰Œç±»å‹</th>
                        <th>é¦–é€‰æƒ…ç»ªå¡ç‰Œ</th>
                        <th>ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œ</th>
                        <th>å†é€‰æƒ…ç»ªå¡ç‰Œ</th>
                        <th>æ€»è®¡</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>

        <!-- åŸºæœ¬ä¿¡æ¯å’Œæ¦‚è¿°å‘ˆç°è¡¨æ ¼ -->
        <table id="basic-info-table">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>æ€§åˆ«</th>
                    <th>å¹´é¾„</th>
                    <th>æ—¥æœŸ</th>
                    <th>å’¨è¯¢äº‹ä»¶</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="name-display"></td>
                    <td id="gender-display"></td>
                    <td id="age-display"></td>
                    <td id="date-display"></td>
                    <td id="consultation-event-display"></td>
                </tr>
                <tr class="overview-row">
                    <td>é¦–é€‰æƒ…ç»ªæ¦‚è¿°</td>
                    <td colspan="4" id="emotion1-overview-display"></td>
                </tr>
                <tr class="overview-row">
                    <td>ä¸­æœŸè¡ŒåŠ¨æ¦‚è¿°</td>
                    <td colspan="4" id="action-overview-display"></td>
                </tr>
                <tr class="overview-row">
                    <td>å†é€‰æƒ…ç»ªæ¦‚è¿°</td>
                    <td colspan="4" id="emotion2-overview-display"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>document.addEventListener('change', function(e) {
  if (e.target.matches('.score-select, .type-select, .word-select, #gender, #date')) {
    updateCharts();
  }
});

document.addEventListener('input', function(e) {
  if (e.target.matches('#name, #age, #consultation-event, .overview-input, .word-select[type="text"]')) {
    updateCharts();
  }
});

        // æƒ…æ„Ÿç‰Œå †å’Œè¡ŒåŠ¨ç‰Œå †è¯æ±‡åº“
        const wordBank = {
            emotion: {
                'æ­£å‘æƒ…ç»ª': ['å¹¸ç¦', 'æ€å¿µ', 'å‘å¾€', 'æ„ŸåŠ¨', 'å‹‡æ°”', 'å¦ç„¶', 'æ»¡è¶³', 'åº†å¹¸', 'è½»æ¾', 'å¿ƒå¹³æ°”å’Œ', 'è‡ªè±ª', 'å…´å¥‹', 'çˆ±'],
                'è´Ÿå‘æƒ…ç»ª': ['æ„¤æ€’', 'è¿·èŒ«', 'å¤±è½', 'è‡ªå‘', 'ç¾è€»', 'æ„§ç–š', 'å¦’å¿Œ', 'çƒ¦èº', 'ç„¦è™‘', 'ç»æœ›', 'æ‚²ä¼¤', 'æ†æ¨', 'ææƒ§'],
                'å†…åœ¨éœ€æ±‚': ['å®‰å…¨æ„Ÿ', 'å¹³è¡¡', 'å°½å–„å°½ç¾', 'è‡ªæˆ‘æ¥çº³', 'è‡ªä¸»æƒ', 'ä¿¡å¿ƒ', 'è‡ªæˆ‘æˆé•¿', 'ç†è§£', 'å°Šé‡', 'è´£ä»»æ„Ÿ', 'æ„ä¹‰æ„Ÿ', 'å½’å±æ„Ÿ', 'æˆå°±æ„Ÿ'],
                'å¤–åœ¨éœ€æ±‚': ['è¢«çœ‹è§', 'ä»˜å‡º', 'å…¬å¹³', 'æœŸå¾…', 'å’Œè°', 'è¾¹ç•Œæ„Ÿ', 'çœŸè¯š', 'åŒ…å®¹', 'é™ªä¼´', 'è¢«ä¿¡ä»»', 'è¢«æ”¯æŒ', 'è¢«éœ€è¦', 'è¢«è®¤å¯']
            },
            action: {
                'ç”Ÿæ´»ä¹è¶£': ['å€¾è¯‰', 'å–é…’', 'æ¢³å¦†æ‰“æ‰®', 'åšæ¸…æ´', 'å…»å® ç‰©', 'å…»èŠ±è‰', 'ç©æ¸¸æˆ', 'è¿½å‰§', 'é˜…è¯»', 'è´­ç‰©', 'æ—…æ¸¸', 'å¬éŸ³ä¹', 'ç¡è§‰'],
                'æŠ€èƒ½åŸ¹å…»': ['å†™ä½œ', 'è·³è¡—èˆ', 'æ‘„å½±', 'çƒ˜ç„™', 'çƒ¹é¥ª', 'èŒ¶è‰º', 'æ’èŠ±', 'æ¶‚é¸¦', 'åšæ‰‹å·¥', 'ç»˜ç”»', 'æ¼”å¥ä¹å™¨', 'å”±æ­Œ', 'æ¼”è®²'],
                'è¿åŠ¨é”»ç‚¼': ['æ•£æ­¥', 'æ‰“å¤ªæ', 'æ‹³å‡»', 'æ£‹ç±»è¿åŠ¨', 'çˆ¬å±±', 'è·³ç»³', 'è·³èˆ', 'æ¸¸æ³³', 'æŒ¥æ‹è¿åŠ¨', 'ä¸‰å¤§çƒè¿åŠ¨', 'å¥èº«', 'éª‘è½¦', 'è·‘æ­¥'],
                'è‡ªæˆ‘æå‡': ['æ€»ç»“åæ€', 'å¿ƒç†å’¨è¯¢', 'è°ƒä¾ƒ', 'åšå–„äº‹', 'ç‹¬å¤„', 'æ„Ÿæ‚Ÿ', 'å­¦ä¼šæ‹’ç»', 'ä¸»åŠ¨ç¤¾äº¤', 'ä¸»åŠ¨æ±‚åŠ©', 'æŠ•å…¥å­¦ä¹ ', 'æŠ•å…¥å·¥ä½œ', 'è‡ªæˆ‘é¼“åŠ±', 'è‡ªæˆ‘è§‰å¯Ÿ']
            }
        };

        const cardConfig = {
            emotionTypes: {
                'æ­£å‘æƒ…ç»ª': { color: '#FF6384' },
                'è´Ÿå‘æƒ…ç»ª': { color: '#36A2EB' },
                'å†…åœ¨éœ€æ±‚': { color: '#FFCE56' },
                'å¤–åœ¨éœ€æ±‚': { color: '#4BC0C0' }
            },
            actionTypes: {
                'ç”Ÿæ´»ä¹è¶£': { color: '#FF6384' },
                'æŠ€èƒ½åŸ¹å…»': { color: '#36A2EB' },
                'è¿åŠ¨é”»ç‚¼': { color: '#4BC0C0' },
                'è‡ªæˆ‘æå‡': { color: '#FFCE56' }
            }
        };

        let chartInstances = {
            emotion1: null,
            emotion2: null,
            actionType: null,
            comparison: null,
            actionScore: null
        };

        // æ•°æ®å­˜å‚¨
        let data = {
            emotions1: [],
            actions: [],
            emotions2: [],
            overviews: {
                emotion1: '',
                action: '',
                emotion2: ''
            },
            getEmotionStats: (section) => {
                const stats = { counts: {}, scores: {} };
                data[section].forEach(item => {
                    stats.counts[item.type] = (stats.counts[item.type] || 0) + 1;
                    stats.scores[item.type] = (stats.scores[item.type] || 0) + (item.score || 0);
                });
                return stats;
            },
            getActionStats: () => {
                const stats = { counts: {}, scores: {}, details: {} };
                data.actions.forEach(item => {
                    stats.counts[item.type] = (stats.counts[item.type] || 0) + 1;
                    stats.scores[item.type] = (stats.scores[item.type] || 0) + (item.score || 0);
                    if (!stats.details[item.type]) stats.details[item.type] = [];
                    stats.details[item.type].push(`${item.name} (${item.score})`);
                });
                return stats;
            },
            getAllCardStats: () => {
                // åˆå§‹åŒ–ç»Ÿè®¡å¯¹è±¡
                const stats = {};
                
                // åˆå§‹åŒ–æ‰€æœ‰æƒ…ç»ªç±»å‹
                Object.keys(cardConfig.emotionTypes).forEach(type => {
                    stats[type] = {
                        emotion1: 0,
                        action: 0,
                        emotion2: 0,
                        total: 0,
                        color: cardConfig.emotionTypes[type].color
                    };
                });
                
                // åˆå§‹åŒ–æ‰€æœ‰è¡ŒåŠ¨ç±»å‹
                Object.keys(cardConfig.actionTypes).forEach(type => {
                    stats[type] = {
                        emotion1: 0,
                        action: 0,
                        emotion2: 0,
                        total: 0,
                        color: cardConfig.actionTypes[type].color
                    };
                });
                
                // ç»Ÿè®¡é¦–é€‰æƒ…ç»ªå¡ç‰Œ
                data.emotions1.forEach(item => {
                    if (stats[item.type]) {
                        stats[item.type].emotion1++;
                    }
                });
                
                // ç»Ÿè®¡ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œ
                data.actions.forEach(item => {
                    if (stats[item.type]) {
                        stats[item.type].action++;
                    }
                });
                
                // ç»Ÿè®¡å†é€‰æƒ…ç»ªå¡ç‰Œ
                data.emotions2.forEach(item => {
                    if (stats[item.type]) {
                        stats[item.type].emotion2++;
                    }
                });
                
                // è®¡ç®—æ€»è®¡
                Object.values(stats).forEach(typeStats => {
                    typeStats.total = typeStats.emotion1 + typeStats.action + typeStats.emotion2;
                });
                
                return stats;
            }
        };

        // åˆ‡æ¢å†…å®¹æ¦‚è¿°è¾“å…¥æ¡†çš„æ˜¾ç¤º/éšè—
        function toggleOverview(id) {
            const container = document.getElementById(id);
            container.style.display = container.style.display === 'block' ? 'none' : 'block';
        }

        // åˆ›å»ºåˆ†å€¼é€‰æ‹©ä¸‹æ‹‰æ¡†
        function createScoreSelect() {
            const select = document.createElement('select');
            select.className = 'score-select';
            select.onchange = updateCharts;
            
            // æ·»åŠ ç©ºé€‰é¡¹ä½œä¸ºé»˜è®¤
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©åˆ†å€¼';
            select.appendChild(defaultOption);
            
            // æ·»åŠ 1-7åˆ†é€‰é¡¹
            for (let i = 1; i <= 7; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            }
            
            return select;
        }

        // åˆ›å»ºè¯æ±‡é€‰æ‹©ä¸‹æ‹‰æ¡†
        function createWordSelect(type, isEmotion, isBlank) {
            const select = document.createElement('select');
            select.className = 'word-select';
            select.onchange = updateCharts;
            
            // å¦‚æœæ˜¯ç©ºç™½å¡ï¼Œä½¿ç”¨è¾“å…¥æ¡†
            if (isBlank) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'word-select';
                input.placeholder = 'æ‰‹åŠ¨è¾“å…¥è¯æ±‡';
                input.oninput = updateCharts;
                return input;
            }
            
            // éç©ºç™½å¡ï¼Œä½¿ç”¨ä¸‹æ‹‰æ¡†å¹¶å¡«å……è¯æ±‡
            updateWordOptions(select, type, isEmotion);
            return select;
        }

        // æ›´æ–°è¯æ±‡ä¸‹æ‹‰æ¡†é€‰é¡¹
        function updateWordOptions(select, type, isEmotion) {
            // ä¿å­˜å½“å‰é€‰ä¸­å€¼
            const currentValue = select.value;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '';
            
            // æ·»åŠ é»˜è®¤é€‰é¡¹
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©è¯æ±‡';
            select.appendChild(defaultOption);
            
            // è·å–å¯¹åº”ç±»å‹çš„è¯æ±‡
            const bank = isEmotion ? wordBank.emotion : wordBank.action;
            const words = bank[type] || [];
            
            // æ·»åŠ è¯æ±‡é€‰é¡¹
            words.forEach(word => {
                const option = document.createElement('option');
                option.value = word;
                option.textContent = word;
                select.appendChild(option);
            });
            
            // å°è¯•æ¢å¤ä¹‹å‰çš„é€‰ä¸­å€¼
            if (currentValue && words.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // åŠ¨æ€æ·»åŠ è¾“å…¥é¡¹
        function createInputGroup(typeOptions, isEmotion, isBlank) {
            const group = document.createElement('div');
            group.className = 'input-group';
            
            // åˆ›å»ºç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            const typeSelect = document.createElement('select');
            typeSelect.className = 'type-select';
            
            // å¡«å……ç±»å‹é€‰é¡¹
            const typeEntries = Object.entries(typeOptions);
            typeEntries.forEach(([typeName]) => {
                const option = document.createElement('option');
                option.value = typeName;
                option.textContent = typeName;
                typeSelect.appendChild(option);
            });
            
            // è·å–é»˜è®¤ç±»å‹
            const defaultType = typeEntries[0][0];
            
            // åˆ›å»ºè¯æ±‡é€‰æ‹©ç»„ä»¶
            const wordSelect = createWordSelect(defaultType, isEmotion, isBlank);
            
            // åˆ›å»ºåˆ†å€¼é€‰æ‹©ä¸‹æ‹‰æ¡†
            const scoreSelect = createScoreSelect();
            
            // åˆ›å»ºç±»å‹æ ‡ç­¾
            const typeLabel = document.createElement('span');
            typeLabel.className = 'card-type';
            typeLabel.style.background = typeOptions[defaultType].color;
            typeLabel.textContent = defaultType;
            
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '- åˆ é™¤';
            deleteBtn.onclick = function() { deleteInputGroup(this); };
            
            // ç±»å‹å˜åŒ–æ—¶æ›´æ–°ç›¸å…³ç»„ä»¶
            typeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                // æ›´æ–°æ ‡ç­¾æ ·å¼å’Œæ–‡æœ¬
                typeLabel.style.background = typeOptions[selectedType].color;
                typeLabel.textContent = selectedType;
                
                // å¦‚æœä¸æ˜¯ç©ºç™½å¡ï¼Œæ›´æ–°è¯æ±‡é€‰é¡¹
                if (!isBlank && wordSelect.tagName === 'SELECT') {
                    updateWordOptions(wordSelect, selectedType, isEmotion);
                }
                
                // æ›´æ–°å›¾è¡¨
                updateCharts();
            });
            
            // æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°è¾“å…¥ç»„
            group.appendChild(typeSelect);
            group.appendChild(wordSelect);
            group.appendChild(scoreSelect);
            group.appendChild(typeLabel);
            group.appendChild(deleteBtn);
            
            return group;
        }

        // åˆ é™¤è¾“å…¥é¡¹
        function deleteInputGroup(button) {
            const inputGroup = button.closest('.input-group');
            if (inputGroup) {
                inputGroup.remove();
                updateCharts();
            }
        }

        function addEmotionInput(section, isBlank) {
            const container = document.getElementById(`${section}-inputs`);
            container.appendChild(createInputGroup(cardConfig.emotionTypes, true, isBlank));
            updateCharts();
        }

        function addActionInput(isBlank) {
            const container = document.getElementById('action-inputs');
            container.appendChild(createInputGroup(cardConfig.actionTypes, false, isBlank));
            updateCharts();
        }

        // æ•°æ®æ”¶é›†
        function collectData() {
            const getData = (containerId) =>
                Array.from(document.querySelectorAll(`#${containerId} .input-group`)).map(div => {
                    const wordElement = div.querySelector('.word-select');
                    return {
                        type: div.querySelector('.type-select').value,
                        name: wordElement.tagName === 'INPUT' ? wordElement.value : wordElement.value,
                        score: parseInt(div.querySelector('.score-select').value) || 0
                    };
                });

            data.emotions1 = getData('emotion1-inputs');
            data.actions = getData('action-inputs');
            data.emotions2 = getData('emotion2-inputs');
            
            // æ”¶é›†æ¦‚è¿°å†…å®¹
            data.overviews.emotion1 = document.querySelector('#emotion1-overview textarea').value;
            data.overviews.action = document.querySelector('#action-overview textarea').value;
            data.overviews.emotion2 = document.querySelector('#emotion2-overview textarea').value;
        }

        // å›¾è¡¨æ›´æ–°
        function updateCharts() {
            collectData();
            destroyCharts();
            renderEmotionChart('emotion1', 'é¦–é€‰æƒ…ç»ªåˆ†å¸ƒ');
            renderEmotionChart('emotion2', 'å†é€‰æƒ…ç»ªåˆ†å¸ƒ');
            renderActionTypeChart();
            renderComparisonChart();
            renderActionScoreChart();
            updateBasicInfoTable();
            updateCardStatsTable();
        }

        function renderEmotionChart(section, title) {
            const stats = data.getEmotionStats(`emotions${section.slice(-1)}`);
            const ctx = document.getElementById(`${section}Chart`).getContext('2d');
            chartInstances[section] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.counts),
                    datasets: [{
                        data: Object.values(stats.counts),
                        backgroundColor: Object.keys(stats.counts).map(k => cardConfig.emotionTypes[k].color)
                    }]
                },
                options: { title: { display: true, text: title } }
            });
        }

        function renderActionTypeChart() {
            const stats = data.getActionStats();
            const ctx = document.getElementById('actionTypeChart').getContext('2d');
            chartInstances.actionType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.counts),
                    datasets: [{
                        data: Object.values(stats.counts),
                        backgroundColor: Object.keys(stats.counts).map(k => cardConfig.actionTypes[k].color)
                    }]
                },
                options: { title: { display: true, text: 'è¡ŒåŠ¨ç±»å‹åˆ†å¸ƒ' } }
            });
        }

        function renderComparisonChart() {
            const stats1 = data.getEmotionStats('emotions1').scores;
            const stats2 = data.getEmotionStats('emotions2').scores;
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            chartInstances.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(cardConfig.emotionTypes),
                    datasets: [{
                        label: 'é¦–é€‰æƒ…ç»ª',
                        data: Object.keys(cardConfig.emotionTypes).map(k => stats1[k] || 0),
                        backgroundColor: '#FF6384'
                    }, {
                        label: 'å†é€‰æƒ…ç»ª',
                        data: Object.keys(cardConfig.emotionTypes).map(k => stats2[k] || 0),
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    title: { display: true, text: 'æƒ…ç»ªå¼ºåº¦å¯¹æ¯”' },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderActionScoreChart() {
            const stats = data.getActionStats();
            const ctx = document.getElementById('actionScoreChart').getContext('2d');
            chartInstances.actionScore = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(cardConfig.actionTypes),
                    datasets: [{
                        label: 'è¡ŒåŠ¨æ„æ„¿åº¦',
                        data: Object.keys(cardConfig.actionTypes).map(k => stats.scores[k] || 0),
                        backgroundColor: Object.keys(cardConfig.actionTypes).map(k => cardConfig.actionTypes[k].color)
                    }]
                },
                options: {
                    title: { display: true, text: 'è¡ŒåŠ¨åˆ†å€¼åˆ†å¸ƒ' },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // æ›´æ–°å¡ç‰Œç»Ÿè®¡è¡¨æ ¼
        function updateCardStatsTable() {
            const stats = data.getAllCardStats();
            const tableBody = document.querySelector('#card-stats-table tbody');
            tableBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼
            
            // æ·»åŠ æƒ…ç»ªç±»å‹è¡Œ
            Object.keys(cardConfig.emotionTypes).forEach(type => {
                const typeStats = stats[type];
                const row = document.createElement('tr');
                
                // ç±»å‹åç§°å•å…ƒæ ¼ï¼ˆå¸¦é¢œè‰²æŒ‡ç¤ºå™¨ï¼‰
                const typeCell = document.createElement('td');
                typeCell.innerHTML = `<span class="color-indicator" style="background-color: ${typeStats.color}"></span>${type}`;
                row.appendChild(typeCell);
                
                // é¦–é€‰æƒ…ç»ªå¡ç‰Œæ•°é‡
                const emotion1Cell = document.createElement('td');
                emotion1Cell.textContent = typeStats.emotion1;
                row.appendChild(emotion1Cell);
                
                // ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œæ•°é‡ï¼ˆæƒ…ç»ªç±»å‹åœ¨è¡ŒåŠ¨ä¸­é€šå¸¸ä¸º0ï¼‰
                const actionCell = document.createElement('td');
                actionCell.textContent = typeStats.action;
                row.appendChild(actionCell);
                
                // å†é€‰æƒ…ç»ªå¡ç‰Œæ•°é‡
                const emotion2Cell = document.createElement('td');
                emotion2Cell.textContent = typeStats.emotion2;
                row.appendChild(emotion2Cell);
                
                // æ€»è®¡
                const totalCell = document.createElement('td');
                totalCell.textContent = typeStats.total;
                row.appendChild(totalCell);
                
                tableBody.appendChild(row);
            });
            
            // æ·»åŠ è¡ŒåŠ¨ç±»å‹è¡Œ
            Object.keys(cardConfig.actionTypes).forEach(type => {
                const typeStats = stats[type];
                const row = document.createElement('tr');
                
                // ç±»å‹åç§°å•å…ƒæ ¼ï¼ˆå¸¦é¢œè‰²æŒ‡ç¤ºå™¨ï¼‰
                const typeCell = document.createElement('td');
                typeCell.innerHTML = `<span class="color-indicator" style="background-color: ${typeStats.color}"></span>${type}`;
                row.appendChild(typeCell);
                
                // é¦–é€‰æƒ…ç»ªå¡ç‰Œæ•°é‡ï¼ˆè¡ŒåŠ¨ç±»å‹åœ¨æƒ…ç»ªä¸­é€šå¸¸ä¸º0ï¼‰
                const emotion1Cell = document.createElement('td');
                emotion1Cell.textContent = typeStats.emotion1;
                row.appendChild(emotion1Cell);
                
                // ä¸­æœŸè¡ŒåŠ¨å¡ç‰Œæ•°é‡
                const actionCell = document.createElement('td');
                actionCell.textContent = typeStats.action;
                row.appendChild(actionCell);
                
                // å†é€‰æƒ…ç»ªå¡ç‰Œæ•°é‡ï¼ˆè¡ŒåŠ¨ç±»å‹åœ¨æƒ…ç»ªä¸­é€šå¸¸ä¸º0ï¼‰
                const emotion2Cell = document.createElement('td');
                emotion2Cell.textContent = typeStats.emotion2;
                row.appendChild(emotion2Cell);
                
                // æ€»è®¡
                const totalCell = document.createElement('td');
                totalCell.textContent = typeStats.total;
                row.appendChild(totalCell);
                
                tableBody.appendChild(row);
            });
            
            // æ·»åŠ æ€»è®¡è¡Œ
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            
            // æ€»è®¡æ ‡é¢˜å•å…ƒæ ¼
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'åˆè®¡';
            totalRow.appendChild(totalLabelCell);
            
            // è®¡ç®—å„åˆ—æ€»è®¡
            let totalEmotion1 = 0;
            let totalAction = 0;
            let totalEmotion2 = 0;
            let totalAll = 0;
            
            Object.values(stats).forEach(typeStats => {
                totalEmotion1 += typeStats.emotion1;
                totalAction += typeStats.action;
                totalEmotion2 += typeStats.emotion2;
                totalAll += typeStats.total;
            });
            
            // æ·»åŠ å„åˆ—æ€»è®¡å•å…ƒæ ¼
            const totalEmotion1Cell = document.createElement('td');
            totalEmotion1Cell.textContent = totalEmotion1;
            totalRow.appendChild(totalEmotion1Cell);
            
            const totalActionCell = document.createElement('td');
            totalActionCell.textContent = totalAction;
            totalRow.appendChild(totalActionCell);
            
            const totalEmotion2Cell = document.createElement('td');
            totalEmotion2Cell.textContent = totalEmotion2;
            totalRow.appendChild(totalEmotion2Cell);
            
            const totalAllCell = document.createElement('td');
            totalAllCell.textContent = totalAll;
            totalRow.appendChild(totalAllCell);
            
            tableBody.appendChild(totalRow);
        }

        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => chart && chart.destroy());
        }

        function updateBasicInfoTable() {
            const name = document.getElementById('name').value;
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const date = document.getElementById('date').value;
            const consultationEvent = document.getElementById('consultation-event').value;
            
            // è·å–æ¦‚è¿°å†…å®¹
            const emotion1Overview = data.overviews.emotion1;
            const actionOverview = data.overviews.action;
            const emotion2Overview = data.overviews.emotion2;

            document.getElementById('name-display').textContent = name;
            document.getElementById('gender-display').textContent = gender;
            document.getElementById('age-display').textContent = age;
            document.getElementById('date-display').textContent = date;
            document.getElementById('consultation-event-display').textContent = consultationEvent;
            
            // æ›´æ–°æ¦‚è¿°å†…å®¹åˆ°è¡¨æ ¼
            document.getElementById('emotion1-overview-display').textContent = emotion1Overview;
            document.getElementById('action-overview-display').textContent = actionOverview;
            document.getElementById('emotion2-overview-display').textContent = emotion2Overview;
        }

        function saveAsImage() {
            const container = document.querySelector('.container');
            html2canvas(container).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = imgData;
                a.download = `PEæŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.png`;
                a.click();
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addEmotionInput('emotion1', false);
            addActionInput(false);
            addEmotionInput('emotion2', false);
            updateCharts();
        });
    </script>
</body>

</html>
